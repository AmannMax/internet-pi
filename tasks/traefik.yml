---
- name: Create traefik folder on Pi.
  ansible.builtin.file:
    path: "{{ config_dir }}/traefik"
    state: directory
    mode: 0755
  become: false

- name: Create letsencrypt folder on Pi.
  ansible.builtin.file:
    path: "{{ config_dir }}/traefik/letsencrypt"
    state: directory
    mode: "0755"
  become: false

- name: Create configuration folder on Pi.
  ansible.builtin.file:
    path: "{{ config_dir }}/traefik/configuration"
    state: directory
    mode: "0755"
  become: false

- name: Copy traefik configuration to Pi.
  ansible.builtin.copy:
    src: "../traefik/{{ item.src }}"
    dest: "{{ config_dir }}/configuration/{{ item.dest }}"
    mode: "0755"
  loop:
    - src: dynamic.yml
      dest: dynamic.yml
    - src: traefik.yml
      dest: traefik.yml

- name: Copy traefik .env file to Pi.
  ansible.builtin.copy:
    src: .env
    dest: "{{ config_dir }}/.env"
    mode: "0755"
  become: false

- name: Create ACME file for traefik
  ansible.builtin.file:
    path: "{{ config_dir }}/traefik/letsencrypt/acme.json"
    state: touch
    mode: "0600"
  become: false

- name: Copy traefik docker-compose template to Pi.
  ansible.builtin.template:
    src: templates/traefik-docker-compose.yml.j2
    dest: "{{ config_dir }}/traefik/docker-compose.yml"
    mode: "0640"
  become: false
  # notify: Restart traefik

# TODO: The first time this playbook is run, the `pi` user may not be added
# to the `docker` group, so this task may fail.
- name: Ensure traefik is running.
  community.docker.docker_compose:
    project_src: "{{ config_dir }}/traefik/"
    build: false
  become: false
